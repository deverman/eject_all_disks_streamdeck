name: Build and Package Plugin

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  release:
    types: [created]

jobs:
  build-and-package:
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint check
        run: npm run lint:check
        continue-on-error: true

      - name: Build Swift binary
        run: npm run build:swift

      - name: Build plugin
        run: npm run build

      - name: Verify build output
        run: |
          echo "Checking required files..."
          if [ ! -f "org.deverman.ejectalldisks.sdPlugin/bin/plugin.js" ]; then
            echo "Error: plugin.js not found after build"
            exit 1
          fi
          if [ ! -f "org.deverman.ejectalldisks.sdPlugin/bin/eject-disks" ]; then
            echo "Error: Swift binary eject-disks not found after build"
            exit 1
          fi
          if [ ! -f "org.deverman.ejectalldisks.sdPlugin/bin/install-eject-privileges.sh" ]; then
            echo "Error: install-eject-privileges.sh not found"
            exit 1
          fi
          echo "âœ… All required files present"
          echo ""
          echo "Contents of bin directory:"
          ls -lh org.deverman.ejectalldisks.sdPlugin/bin/
          echo ""
          echo "Swift binary info:"
          file org.deverman.ejectalldisks.sdPlugin/bin/eject-disks

      - name: Install StreamDeck CLI
        run: npm install -g @elgato/cli

      - name: Validate plugin
        run: npx streamdeck validate org.deverman.ejectalldisks.sdPlugin || true
        continue-on-error: true

      - name: Package plugin
        run: |
          mkdir -p dist
          cd org.deverman.ejectalldisks.sdPlugin
          zip -r ../dist/org.deverman.ejectalldisks.streamDeckPlugin . \
            -x "*.DS_Store" \
            -x "logs/*" \
            -x "*.log" \
            -x ".git/*" \
            -x ".gitignore"
          cd ..

      - name: Verify package
        run: |
          if [ ! -f "dist/org.deverman.ejectalldisks.streamDeckPlugin" ]; then
            echo "Error: Package file not found"
            exit 1
          fi
          ls -lh dist/org.deverman.ejectalldisks.streamDeckPlugin
          echo "Package created successfully"

      - name: Upload plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: streamdeck-plugin
          path: dist/org.deverman.ejectalldisks.streamDeckPlugin
          retention-days: 30

      - name: Upload to release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: dist/org.deverman.ejectalldisks.streamDeckPlugin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
