<!doctype html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover"
		/>
		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black" />
		<title>Eject All Disks Settings</title>
		<link rel="stylesheet" href="../libs/css/sdpi.css" />
	</head>
	<body>
		<div class="sdpi-wrapper">
			<div class="sdpi-item">
				<div class="sdpi-item-label">Title</div>
				<div class="sdpi-item-value">
					<div class="sdpi-item-child">
						<input id="showTitle" type="checkbox" checked />
						<label for="showTitle" class="sdpi-item-label"><span></span>Show text on button</label>
					</div>
				</div>
			</div>

			<div class="sdpi-heading">Privilege Setup</div>

			<div class="sdpi-item">
				<div class="sdpi-item-label">Status</div>
				<div class="sdpi-item-value">
					<span id="setupStatus" style="color: #888;">Checking...</span>
				</div>
			</div>

			<div id="setupInstructions" class="sdpi-item" style="display: none;">
				<details class="message">
					<summary>Setup Instructions</summary>
					<p style="font-size: 11px; margin: 8px 0; line-height: 1.4;">
						To eject disks without password prompts, run the setup script once:
					</p>
					<ol style="font-size: 11px; margin: 8px 0; padding-left: 20px; line-height: 1.6;">
						<li>Open Terminal</li>
						<li>Run: <code id="setupCommand" style="background: #333; padding: 2px 4px; border-radius: 3px; font-size: 10px;">Loading...</code></li>
						<li>Enter your admin password when prompted</li>
						<li>Click "Check Status" to verify</li>
					</ol>
					<button id="copyCommand" class="sdpi-item-value" style="margin: 8px 0; padding: 4px 8px; cursor: pointer;">Copy Command</button>
				</details>
			</div>

			<div class="sdpi-item">
				<div class="sdpi-item-label"></div>
				<button id="checkStatus" class="sdpi-item-value" style="padding: 6px 12px; cursor: pointer;">Check Status</button>
			</div>
		</div>

		<script src="../libs/js/property-inspector.js"></script>
		<script>
			function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo, inActionInfo) {
				var websocket = null;
				var uuid = inPluginUUID;
				var actionInfo = JSON.parse(inActionInfo);
				var info = JSON.parse(inInfo);
				var setupCommandText = "";

				function registerPlugin(inRegisterEvent) {
					var json = {
						event: inRegisterEvent,
						uuid: uuid,
					};
					websocket.send(JSON.stringify(json));
				}

				function updateSetupStatus(status) {
					var statusEl = document.getElementById("setupStatus");
					var instructionsEl = document.getElementById("setupInstructions");

					if (status.configured) {
						statusEl.textContent = "✓ Configured";
						statusEl.style.color = "#34C759";
						instructionsEl.style.display = "none";
					} else {
						statusEl.textContent = "✗ Not configured";
						statusEl.style.color = "#FF9F0A";
						instructionsEl.style.display = "block";

						if (status.setupCommand) {
							setupCommandText = status.setupCommand;
							document.getElementById("setupCommand").textContent = status.setupCommand;
						}
					}
				}

				function requestSetupStatus() {
					if (websocket) {
						var json = {
							event: "sendToPlugin",
							action: actionInfo.action,
							context: uuid,
							payload: {
								checkSetupStatus: true,
							},
						};
						websocket.send(JSON.stringify(json));
					}
				}

				websocket = new WebSocket("ws://127.0.0.1:" + inPort);

				websocket.onopen = function () {
					registerPlugin(inRegisterEvent);
					requestSettings();
					requestSetupStatus();
				};

				websocket.onmessage = function (evt) {
					var jsonObj = JSON.parse(evt.data);
					var event = jsonObj["event"];
					if (event === "didReceiveSettings") {
						var settings = jsonObj.payload.settings;
						if (settings.showTitle !== undefined) {
							document.getElementById("showTitle").checked = settings.showTitle;
						}
					} else if (event === "sendToPropertyInspector") {
						var payload = jsonObj.payload;
						if (payload.setupStatus !== undefined) {
							updateSetupStatus(payload.setupStatus);
						}
					}
				};

				function sendSettings() {
					if (websocket) {
						var showTitle = document.getElementById("showTitle").checked;
						var json = {
							event: "setSettings",
							context: uuid,
							payload: {
								showTitle: showTitle,
							},
						};
						websocket.send(JSON.stringify(json));
					}
				}

				function requestSettings() {
					if (websocket) {
						var json = {
							event: "getSettings",
							context: uuid,
						};
						websocket.send(JSON.stringify(json));
					}
				}

				document.getElementById("showTitle").addEventListener("change", sendSettings);

				document.getElementById("checkStatus").addEventListener("click", function () {
					document.getElementById("setupStatus").textContent = "Checking...";
					document.getElementById("setupStatus").style.color = "#888";
					requestSetupStatus();
				});

				document.getElementById("copyCommand").addEventListener("click", function () {
					if (setupCommandText) {
						navigator.clipboard.writeText(setupCommandText).then(
							function () {
								document.getElementById("copyCommand").textContent = "Copied!";
								setTimeout(function () {
									document.getElementById("copyCommand").textContent = "Copy Command";
								}, 2000);
							},
							function () {
								document.getElementById("copyCommand").textContent = "Failed to copy";
							}
						);
					}
				});
			}
		</script>
	</body>
</html>
